# Microsoft 365 Integration Endpoints

Manage Microsoft 365 tenant integrations and monitor users, licenses, and services.

## List Tenants

```http
GET /api/v1/m365/tenants
```

### Query Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `limit` | integer | Number of results to return (default: 20) |
| `offset` | integer | Number of results to skip (default: 0) |
| `client_id` | UUID | Filter by client ID |
| `status` | string | Filter by tenant status (`active`, `inactive`, `error`) |

### Example Response

```json
{
  "data": [
    {
      "id": "123e4567-e89b-12d3-a456-426614174000",
      "client_id": "987fcdeb-51a2-43d7-8f9a-123456789abc",
      "tenant_id": "12345678-1234-1234-1234-123456789012",
      "tenant_name": "Acme Corporation",
      "domain_name": "acme.onmicrosoft.com",
      "display_name": "Acme Corp M365",
      "tenant_type": "business",
      "status": "active",
      "sync_enabled": true,
      "last_sync": "2024-01-15T14:30:00Z",
      "last_sync_status": "success",
      "total_licenses": 150,
      "assigned_licenses": 142,
      "available_licenses": 8,
      "mfa_required": true,
      "security_defaults_enabled": true,
      "created_at": "2024-01-01T10:00:00Z"
    }
  ],
  "pagination": {
    "limit": 20,
    "offset": 0,
    "total": 5,
    "has_more": false
  }
}
```

## Create Tenant

```http
POST /api/v1/m365/tenants
```

### Request Body

```json
{
  "client_id": "987fcdeb-51a2-43d7-8f9a-123456789abc",
  "tenant_id": "12345678-1234-1234-1234-123456789012",
  "tenant_name": "Acme Corporation",
  "domain_name": "acme.onmicrosoft.com",
  "client_id_encrypted": "encrypted_application_id",
  "client_secret_encrypted": "encrypted_client_secret",
  "sync_enabled": true,
  "sync_interval_hours": 6
}
```

### Required Fields

- `client_id` - GhostHub client ID this tenant belongs to
- `tenant_id` - Microsoft 365 tenant ID
- `tenant_name` - Display name for the tenant
- `domain_name` - Primary domain name
- `client_id_encrypted` - Encrypted application (client) ID for API access
- `client_secret_encrypted` - Encrypted client secret for API access

## Get Tenant Users

```http
GET /api/v1/m365/tenants/{tenant_id}/users
```

### Query Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `limit` | integer | Number of results to return |
| `offset` | integer | Number of results to skip |
| `search` | string | Search by display name or email |
| `account_enabled` | boolean | Filter by account status |
| `mfa_enabled` | boolean | Filter by MFA status |

### Example Response

```json
{
  "data": [
    {
      "id": "456e7890-e89b-12d3-a456-426614174111",
      "tenant_id": "123e4567-e89b-12d3-a456-426614174000",
      "user_id": "user123-4567-8901-2345-678901234567",
      "user_principal_name": "john.doe@acme.onmicrosoft.com",
      "display_name": "John Doe",
      "given_name": "John",
      "surname": "Doe",
      "mail": "john.doe@acme.com",
      "job_title": "Senior Developer",
      "department": "Engineering",
      "account_enabled": true,
      "last_sign_in": "2024-01-15T09:30:00Z",
      "mfa_enabled": true,
      "mfa_methods": ["authenticator", "sms"],
      "assigned_licenses": [
        {
          "sku_id": "sku-123",
          "sku_part_number": "ENTERPRISEPACK",
          "product_name": "Microsoft 365 E3"
        }
      ],
      "usage_location": "US",
      "on_premises_sync_enabled": false,
      "last_synced": "2024-01-15T14:30:00Z"
    }
  ],
  "pagination": {
    "limit": 50,
    "offset": 0,
    "total": 142,
    "has_more": true
  }
}
```

## Get Tenant Licenses

```http
GET /api/v1/m365/tenants/{tenant_id}/licenses
```

### Example Response

```json
{
  "data": [
    {
      "id": "789e0123-e89b-12d3-a456-426614174222",
      "tenant_id": "123e4567-e89b-12d3-a456-426614174000",
      "sku_id": "sku-123",
      "sku_part_number": "ENTERPRISEPACK",
      "product_name": "Microsoft 365 E3",
      "total_units": 150,
      "consumed_units": 142,
      "enabled_units": 150,
      "suspended_units": 0,
      "warning_units": 0,
      "cost_per_license": 22.00,
      "annual_cost": 3300.00,
      "service_plans": [
        {
          "service_plan_id": "plan-123",
          "service_plan_name": "EXCHANGE_S_ENTERPRISE",
          "provisioning_status": "Success",
          "applies_to": "User"
        }
      ],
      "purchase_date": "2023-01-01",
      "renewal_date": "2024-01-01"
    }
  ]
}
```

## Sync Tenant

```http
POST /api/v1/m365/tenants/{tenant_id}/sync
```

Manually trigger a full synchronization of tenant data.

### Example Response

```json
{
  "tenant_id": "123e4567-e89b-12d3-a456-426614174000",
  "sync_started": "2024-01-15T15:00:00Z",
  "estimated_duration": "5-10 minutes",
  "sync_types": [
    "users",
    "groups", 
    "licenses",
    "security_settings",
    "usage_reports"
  ]
}
```

## Get Tenant Security Report

```http
GET /api/v1/m365/tenants/{tenant_id}/security
```

### Example Response

```json
{
  "tenant_id": "123e4567-e89b-12d3-a456-426614174000",
  "generated_at": "2024-01-15T15:00:00Z",
  "overall_score": 85,
  "security_defaults": {
    "enabled": true,
    "score": 20,
    "status": "good"
  },
  "mfa_adoption": {
    "total_users": 142,
    "mfa_enabled_users": 138,
    "adoption_rate": 97.2,
    "score": 25,
    "status": "excellent"
  },
  "conditional_access": {
    "policies_count": 5,
    "enabled_policies": 5,
    "coverage": "complete",
    "score": 15,
    "status": "good"
  },
  "identity_protection": {
    "enabled": true,
    "risk_detections": 2,
    "high_risk_users": 0,
    "score": 15,
    "status": "good"
  },
  "device_compliance": {
    "compliant_devices": 134,
    "non_compliant_devices": 8,
    "compliance_rate": 94.4,
    "score": 10,
    "status": "good"
  },
  "recommendations": [
    {
      "category": "mfa",
      "priority": "medium",
      "title": "Enable MFA for remaining 4 users",
      "description": "4 users still don't have MFA enabled",
      "impact": "security"
    }
  ]
}
```

## Get Tenant Usage Reports

```http
GET /api/v1/m365/tenants/{tenant_id}/usage
```

### Query Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `period` | string | Report period (`7d`, `30d`, `90d`, `180d`) |
| `service` | string | Filter by service (`exchange`, `sharepoint`, `teams`, `onedrive`) |

### Example Response

```json
{
  "tenant_id": "123e4567-e89b-12d3-a456-426614174000",
  "period": "30d",
  "generated_at": "2024-01-15T15:00:00Z",
  "summary": {
    "total_active_users": 135,
    "total_inactive_users": 7,
    "activity_rate": 95.1
  },
  "services": {
    "exchange": {
      "active_users": 142,
      "emails_sent": 15420,
      "emails_received": 28730,
      "mailbox_usage_gb": 2450.5
    },
    "sharepoint": {
      "active_users": 98,
      "files_created": 1250,
      "files_shared": 340,
      "storage_used_gb": 1200.2
    },
    "teams": {
      "active_users": 125,
      "meetings_held": 450,
      "messages_sent": 8920,
      "calls_made": 230
    },
    "onedrive": {
      "active_users": 140,
      "files_synced": 5600,
      "storage_used_gb": 850.7
    }
  },
  "trends": {
    "daily_active_users": [
      {"date": "2024-01-01", "count": 132},
      {"date": "2024-01-02", "count": 128}
    ]
  }
}
```

## Webhook Events

The M365 integration supports these webhook events:

- `m365.tenant.sync_completed` - Tenant sync finished
- `m365.tenant.sync_failed` - Tenant sync failed
- `m365.user.created` - New user discovered
- `m365.user.deleted` - User removed
- `m365.license.assigned` - License assigned to user
- `m365.license.unassigned` - License removed from user
- `m365.security.risk_detected` - Security risk detected

### Example Webhook Payload

```json
{
  "event": "m365.tenant.sync_completed",
  "timestamp": "2024-01-15T15:30:00Z",
  "data": {
    "tenant_id": "123e4567-e89b-12d3-a456-426614174000",
    "sync_duration": "00:04:32",
    "users_synced": 142,
    "licenses_synced": 5,
    "errors": 0
  }
}
```